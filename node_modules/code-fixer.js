// code-fixer.js
const ollama = require('ollama').default;
const fs = require('fs').promises;

async function fixCodeWithQwen(filePath) {
  try {
    // 1. –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º –∫–æ–¥–æ–º
    const badCode = await fs.readFile(filePath, 'utf-8');

    // 2. –§–æ—Ä–º–∏—Ä—É–µ–º —á—ë—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç (–∑–∞–ø—Ä–æ—Å) –¥–ª—è –ò–ò
    const prompt = `
      –¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –Ω–∞ JavaScript/Node.js.
      –ï—Å–ª–∏ –≤ –Ω—ë–º –µ—Å—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –ø–ª–æ—Ö–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏–ª–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ ‚Äî –∏—Å–ø—Ä–∞–≤—å –∏—Ö.
      –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –í–ï–°–¨ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –≤ –æ—Ç–≤–µ—Ç–µ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.
      –í–æ—Ç –∫–æ–¥ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
      \`\`\`javascript
      ${badCode}
      \`\`\`
    `;

    // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –º–æ–¥–µ–ª–∏ Qwen Coder
    const response = await ollama.chat({
      model: 'qwen2.5-coder:7b',
      messages: [{ role: 'user', content: prompt }],
      options: { temperature: 0.1 } // –î–µ–ª–∞–µ–º –æ—Ç–≤–µ—Ç—ã –±–æ–ª–µ–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏
    });

    // 4. –í—ã–≤–æ–¥–∏–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥
    console.log('‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –æ—Ç Qwen:');
    console.log('================================');
    console.log(response.message.content);
    console.log('================================');

    // 5. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª
    const fixedCode = response.message.content.replace(/```javascript|```/g, '').trim();
    await fs.writeFile('fixed_' + filePath, fixedCode);
    console.log(`\nüíæ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ñ–∞–π–ª: fixed_${filePath}`);

  } catch (error) {
    console.error('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:', error.message);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –ø–µ—Ä–µ–¥–∞–≤ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –∫–æ–¥–æ–º –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
// –ù–∞–ø—Ä–∏–º–µ—Ä: node code-fixer.js broken-script.js
const targetFile = process.argv[2];
if (!targetFile) {
  console.log('–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: node code-fixer.js <–∏–º—è_—Ñ–∞–π–ª–∞>');
  process.exit(1);
}
fixCodeWithQwen(targetFile);